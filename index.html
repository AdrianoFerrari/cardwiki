<html>
  <head>
    <script src="mousetrap.js"></script>
    <script type="text/javascript" src="elm.js"></script>
    <link rel="stylesheet" href="style.css"/>
  </head>
  <body>
<script type="text/javascript">


/*======= MODEL Parsing from DOM ======= */

// domToModel : Model
var domToModel = function() {
  var data = 
    domToListCard(document.getElementById('model-data'));

  var story = 
    domToListCard(document.getElementById('model-story'));

  if(data.length == 0) {
    var model =
      { "data": []
      , "story": [card("New Card","")]
      , "fieldTitle": "New Card" 
      , "fieldBody": "" 
      , "editing": ["New Card", true]
      , "activeId": "New Card"
      , "activeStory": true
      }
  } else {
    var model =
      { "data": data
      , "story": story
      , "fieldTitle": "" 
      , "fieldBody": "" 
      , "editing": null
      , "activeId": null
      , "activeStory": false
      }
  }

  return model;
}


// domToListCard : Element -> List Card
var domToListCard = function(el) {
  if (el && el.children) {
    return [].slice.call(el.children).map(domToCard)
  } else {
    return [];
  }
}


// domToCard : Element -> Maybe Card
var domToCard = function(el) {
  if (el.title) {
    return card(el.title, el.children[0].innerText);
  } else {
    return null;
  }
}


// card : String -> String -> Card
var card = function(title, body) { 
  return {"title": title, "body": body };
}




/*======= INITIALIZE Elm App ======= */

var cardwiki;
var dirty = false;

var initialize = function() {
  var mainNode = document.getElementById('main');
  var data = domToModel();

  if (mainNode) {
    cardwiki = Elm.Main.embed(mainNode, data);
  } else {
    cardwiki = Elm.Main.fullscreen(data);
  }

  cardwiki.ports.dirty.subscribe(function(bool) {
    dirty = bool;
  });

  cardwiki.ports.execCommand.subscribe(function(cmd) {
    setTimeout(function(){
      document.execCommand(cmd, false);
    }, 10);
  });
}


document.addEventListener('DOMContentLoaded', initialize, false);




/*======= Event Listeners ======= */

window.addEventListener('beforeunload', function(e) {
  if(dirty) {
    e.returnValue = "!!!";
  }
});




/*======= Elm Ports ======= */

var linkClicked = function(title) {
  cardwiki.ports.linkClicked.send(title);
}




/*======= Keyboard Shortcuts ======= */

var shortcuts =
  [ 'j'
  , 'k'
  , 'l'
  , 'h'
  , 'enter'
  , 'mod+enter'
  , 'mod+option+n'
  ]

var needOverride =
  [
  ]

Mousetrap.bind(shortcuts, function(e, s) {
  cardwiki.ports.shortcut.send(s)

  if(needOverride.includes(s)) {
    return false;
  }
});



</script>
  </body>
</html>
